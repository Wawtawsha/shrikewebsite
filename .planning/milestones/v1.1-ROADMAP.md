# v1.1 Roadmap Archive — Event Photo Gallery

**Milestone:** v1.1 Event Photo Gallery
**Started:** 2026-02-08
**Completed:** 2026-02-08
**Phases:** 3 | **Requirements:** 15/15 | **Plans:** 6/6

---

## Phase 1: Gallery Foundation & Infrastructure

**Goal:** Restructure the app for dual-theme support, set up Supabase backend, create upload tooling, and verify the main site is unbroken.

**Requirements:** GALL-01, GALL-02, GALL-03, GALL-04

**What was built:**
- Route group restructure: `app/(main)/` and `app/(gallery)/` with separate root layouts
- CSS theme split: shared `globals.css`, dark `main.css`, warm `gallery.css`
- Supabase client (`lib/supabase.ts`) using `@supabase/supabase-js` (no SSR package)
- Database: 4 tables (`events`, `photos`, `photo_likes`, `photo_comments`) with RLS, triggers, indexes
- Storage: `event-photos` bucket with public read access
- Upload tooling: `scripts/upload-photos.ts` (sharp resize + blurhash) and `scripts/create-event.ts`
- `next.config.ts` updated with Supabase Storage remote patterns

**Plans:**
- 01-01: Route group restructure + CSS theme split + Supabase client setup
- 01-02: Database schema + RLS + triggers + upload tooling

---

## Phase 2: Gallery Display & Design

**Goal:** Build the visible gallery experience — masonry grid, lightbox, progressive loading, warm visual design, and mobile-first responsive layout.

**Requirements:** GALL-05, GALL-06, GALL-07, GALL-08, GALL-13, GALL-14

**What was built:**
- `MasonryGrid.tsx` — react-photo-album v3 masonry with responsive columns (2/3/4/5)
- `GalleryLightbox.tsx` — yet-another-react-lightbox with Zoom plugin, 3x max zoom
- `BlurhashPlaceholder.tsx` — canvas-based blurhash decode, CSS z-index layering
- Server Component data flow: `page.tsx` (async) → `GalleryContent.tsx` → `MasonryGrid.tsx`
- "Load More" button with progress indicator ("Showing X of Y photos")
- Warm oklch palette (cream bg, coral accent, warm browns)
- Mobile-first responsive: 2-col phone, 3-col tablet, 4-5-col desktop, 48px min tap targets

**Plans:**
- 02-01: Masonry grid + data flow + Load More + blurhash placeholders
- 02-02: Lightbox with zoom/swipe + warm theme CSS polish + responsive design

---

## Phase 3: Social Features & Polish

**Goal:** Add anonymous like/comment interactions with spam protection, moderation capability, photo download, and final UX polish.

**Requirements:** GALL-09, GALL-10, GALL-11, GALL-12, GALL-15

**What was built:**
- `LikeButton.tsx` — Heart toggle with optimistic UI, scale-pop animation, `React.memo`
- `useDeviceId.ts` — SSR-safe hook, `crypto.randomUUID()` in localStorage
- `CommentSection.tsx` — Event-level guestbook, optional name, 500 char limit, character counter
- Spam protection: honeypot + 2-second time check + `obscenity` profanity filter + DB trigger rate limit
- `app/api/gallery/moderate/route.ts` — Service role key auth, soft-delete comments
- Download: fetch → `toJpegBlob()` via OffscreenCanvas → `createObjectURL` → click

**Plans:**
- 03-01: Anonymous likes with device ID + comments with form/display
- 03-02: Spam protection layers + moderation endpoint + photo download

**UAT Results:** 10/10 tests passed (1 minor issue fixed: webp→JPEG download format)

---

## Key Technical Decisions

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Route groups with separate root layouts | Clean theme isolation, no conditional logic | Good |
| Supabase Free plan + sharp resize | Avoids $25/mo Pro; resize at upload time | Good |
| `@supabase/supabase-js` only (no SSR) | No auth = no cookie management needed | Good |
| react-photo-album + yet-another-react-lightbox | Purpose-built, React 19 tested, SSR support | Good |
| "Load More" button (not infinite scroll) | Target audience prefers control and orientation | Good |
| localStorage device ID | Simplest, zero friction, sufficient for private events | Good |
| Postgres trigger for rate limiting | Server-enforced, no external dependencies | Good |
| Post-hoc moderation (not pre-moderation) | Preserves live event energy | Good |
| Denormalized like_count via trigger | Avoids COUNT(*) per render | Good |
| CSS z-index blurhash (not JS load detection) | Eliminates race conditions with cached images/hydration | Good |
| JPEG downloads (not webp) | Standard format, universal device support | Good |

---

## Lessons Learned

1. **react-photo-album v3 API**: `RenderImageProps` is directly img props, not `{imageProps}`. `render.image` signature is `(props, context)`.
2. **Blurhash placeholders**: CSS-only z-index layering (canvas at z:0, img at z:1) beats all JS-based load detection approaches. `onLoad`/`useState` is unreliable with cached images and React hydration timing.
3. **useMemo is critical**: `toAlbumPhotos()` must be memoized or react-photo-album remounts all render.image components on every parent re-render.
4. **Cross-origin downloads**: `download` attribute is ignored cross-origin. Must use fetch→blob→createObjectURL pattern.
5. **Next.js 16 searchParams**: `searchParams` is a Promise — must `await` it.

---

*Archived: 2026-02-08*
