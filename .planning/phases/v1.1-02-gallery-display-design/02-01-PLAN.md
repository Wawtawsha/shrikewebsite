---
phase: v1.1-02-gallery-display-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types/gallery.ts
  - lib/gallery.ts
  - app/(gallery)/gallery/page.tsx
  - app/(gallery)/gallery/GalleryContent.tsx
  - components/gallery/MasonryGrid.tsx
  - components/gallery/BlurhashPlaceholder.tsx
  - app/(gallery)/gallery.css
autonomous: true

must_haves:
  truths:
    - "Gallery page at /gallery?event={slug} renders photos in a masonry grid with correct aspect ratios"
    - "First 50 photos render server-side in the initial HTML response"
    - "Load More button fetches the next 50 photos with progress indicator showing 'Showing X of Y photos'"
    - "Photos show blurhash placeholder instantly, replaced by actual image when loaded"
  artifacts:
    - path: "types/gallery.ts"
      provides: "GalleryPhoto and GalleryEvent types matching DB schema"
      exports: ["GalleryPhoto", "GalleryEvent", "PhotoBatch"]
    - path: "lib/gallery.ts"
      provides: "Server-side data fetching for photos with pagination"
      exports: ["fetchEvent", "fetchPhotos"]
    - path: "app/(gallery)/gallery/page.tsx"
      provides: "Server Component that fetches initial 50 photos and event metadata"
      contains: "fetchPhotos"
    - path: "components/gallery/MasonryGrid.tsx"
      provides: "Client component wrapping MasonryPhotoAlbum with Load More"
      contains: "MasonryPhotoAlbum"
    - path: "components/gallery/BlurhashPlaceholder.tsx"
      provides: "Client component that decodes blurhash to canvas for placeholder"
      contains: "blurhash"
  key_links:
    - from: "app/(gallery)/gallery/page.tsx"
      to: "lib/gallery.ts"
      via: "Server Component calls fetchEvent + fetchPhotos at request time"
      pattern: "fetchPhotos|fetchEvent"
    - from: "app/(gallery)/gallery/page.tsx"
      to: "components/gallery/MasonryGrid.tsx"
      via: "Passes initialPhotos and totalCount as props"
      pattern: "initialPhotos.*totalCount"
    - from: "components/gallery/MasonryGrid.tsx"
      to: "lib/gallery.ts"
      via: "Client-side fetch for Load More batches"
      pattern: "fetchPhotos|supabase.*from.*photos"
    - from: "components/gallery/BlurhashPlaceholder.tsx"
      to: "components/gallery/MasonryGrid.tsx"
      via: "Rendered as placeholder while images load"
      pattern: "BlurhashPlaceholder"
---

<objective>
Build the gallery data pipeline and masonry grid with progressive loading and blurhash placeholders.

Purpose: This is the core rendering infrastructure for the photo gallery. Without it, there is no visible gallery -- just the placeholder page from Phase 1. This plan replaces the placeholder GalleryContent with a real data-driven masonry grid.

Output: A working gallery page at `/gallery?event={slug}` that fetches photos from Supabase, renders them in a Pinterest-style masonry layout via react-photo-album, supports "Load More" pagination in batches of 50, and shows blurhash placeholders while images load.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/MASONRY_GRID.md

# Existing files that will be modified or referenced:
@app/(gallery)/gallery/page.tsx
@app/(gallery)/gallery/GalleryContent.tsx
@app/(gallery)/gallery.css
@lib/supabase.ts
@scripts/upload-photos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, data fetching, and Server Component page</name>
  <files>
    types/gallery.ts
    lib/gallery.ts
    app/(gallery)/gallery/page.tsx
  </files>
  <action>
**1. Create `types/gallery.ts`** with types matching the actual DB schema from Phase 1:

```typescript
export interface GalleryEvent {
  id: string;
  slug: string;
  title: string;
  date: string;
  description: string | null;
  cover_photo_url: string | null;
  is_published: boolean;
  created_at: string;
  updated_at: string;
}

export interface GalleryPhoto {
  id: string;
  event_id: string;
  storage_path: string;   // e.g. "winery-event/full/photo1.webp"
  thumb_path: string;      // e.g. "winery-event/thumb/photo1.webp"
  filename: string;
  width: number;
  height: number;
  blurhash: string | null;
  like_count: number;
  sort_order: number;
  created_at: string;
}

export interface PhotoBatch {
  photos: GalleryPhoto[];
  totalCount: number;
  hasMore: boolean;
}
```

**2. Create `lib/gallery.ts`** with two server-side data fetching functions:

- `fetchEvent(slug: string): Promise<GalleryEvent | null>` -- queries `events` table by slug where `is_published = true`. Returns null if not found or not published.

- `fetchPhotos(eventId: string, offset: number, limit: number): Promise<PhotoBatch>` -- queries `photos` table filtered by `event_id`, ordered by `sort_order` ascending, using Supabase `.range(offset, offset + limit - 1)`. Also runs a count query (use `{ count: 'exact', head: true }`) to get `totalCount`. Returns `{ photos, totalCount, hasMore: offset + limit < totalCount }`.

Both functions use the existing `supabase` client from `lib/supabase.ts`. Build the Supabase Storage public URL helper as a simple function: `getStorageUrl(path: string): string` that returns `https://lualkffegfusyibldvqn.supabase.co/storage/v1/object/public/event-photos/${path}`. Actually, use `process.env.NEXT_PUBLIC_SUPABASE_URL` to construct it dynamically instead of hardcoding the project ID.

**3. Rewrite `app/(gallery)/gallery/page.tsx`** as a proper Server Component:

- Accept `searchParams` from the page props (Next.js 16 async searchParams).
- Read `event` slug from searchParams.
- If no slug, render a "No event specified" message.
- Call `fetchEvent(slug)` -- if null, render "Event not found" message.
- Call `fetchPhotos(eventId, 0, 50)` for the initial batch.
- Render `<GalleryContent>` passing: `event`, `initialPhotos`, `totalCount`, `hasMore` as props.
- Keep the existing `<Suspense>` wrapper for the client component.

Important: Next.js 16 makes `searchParams` a Promise. Use `const params = await searchParams;` before accessing `params.event`.
  </action>
  <verify>
- `npm run build` passes with no type errors
- Verify `types/gallery.ts` exports all three types
- Verify `lib/gallery.ts` exports `fetchEvent`, `fetchPhotos`, `getStorageUrl`
- Verify `page.tsx` is a Server Component (no "use client" directive) and uses async searchParams
  </verify>
  <done>
- TypeScript types match the DB schema (events, photos tables)
- Data fetching functions query Supabase with pagination support
- Server Component page fetches initial 50 photos and passes them as props to the client component
- No event / event not found states handled gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Masonry grid with Load More and blurhash placeholders</name>
  <files>
    components/gallery/MasonryGrid.tsx
    components/gallery/BlurhashPlaceholder.tsx
    app/(gallery)/gallery/GalleryContent.tsx
    app/(gallery)/gallery.css
  </files>
  <action>
**0. Install dependencies:**
```bash
npm install react-photo-album yet-another-react-lightbox blurhash
```
Note: `blurhash` is currently a devDependency (used by upload script). It needs to be a regular dependency for client-side decoding. Installing it again with `npm install` will move it to dependencies.

**1. Create `components/gallery/BlurhashPlaceholder.tsx`** ("use client"):

- Accepts props: `blurhash: string`, `width: number`, `height: number`
- Uses `decode` from the `blurhash` package to decode the hash into pixel data
- Renders a `<canvas>` element that displays the decoded blurhash
- Canvas should be sized to a small decode resolution (32x32) but displayed at full container size via CSS (`width: 100%; height: 100%; object-fit: cover`)
- Decode in a `useEffect` on mount. Memoize the decoded pixels to avoid re-decoding on every render.
- If blurhash is null/empty, render a simple warm-colored div placeholder (use `bg-surface` from the gallery theme)

**2. Create `components/gallery/MasonryGrid.tsx`** ("use client"):

- Import `MasonryPhotoAlbum` from `react-photo-album` and `import "react-photo-album/masonry.css"`
- Props: `initialPhotos: GalleryPhoto[]`, `totalCount: number`, `hasMore: boolean`, `eventId: string`
- Internal state: `photos` (starts with initialPhotos), `loading` (boolean), `hasMoreState` (starts with hasMore)
- Map `GalleryPhoto[]` to the react-photo-album `Photo` format: `{ src: getStorageUrl(photo.thumb_path), width: photo.width, height: photo.height, key: photo.id }`. Store the original `GalleryPhoto` data alongside for later use (lightbox, blurhash). Use a custom type that extends the library's Photo type with `galleryPhoto: GalleryPhoto`.
- Configure `MasonryPhotoAlbum` with:
  - `columns` function: return 2 for width < 480, 3 for width < 768, 4 for width < 1200, 5 otherwise
  - `spacing` of 8 (pixels between photos)
  - `defaultContainerWidth` of 1200 (for SSR rendering)
  - Custom `render.image` prop that wraps the default `<img>` with a position-relative container showing `<BlurhashPlaceholder>` behind it. When the image `onLoad` fires, hide the placeholder (use a `loaded` state per image). Apply `loading="lazy"` and `decoding="async"` to the img.
  - `onClick` handler: store the clicked photo index in state (for lightbox integration in Plan 02)
- **Load More button:**
  - Rendered below the `MasonryPhotoAlbum` component
  - Shows "See more photos" text with a large tap target (min 48px height, full-width on mobile)
  - Styled with warm coral accent: `bg-accent text-white rounded-full px-8 py-3 hover:bg-accent-hover transition-colors`
  - On click: set `loading=true`, fetch next batch from Supabase using the existing `supabase` client directly (import from `lib/supabase.ts`), append results to `photos` state, update `hasMoreState`
  - While loading: show "Loading..." with a simple CSS spinner
  - When no more photos: hide the button
- **Progress indicator:**
  - Below the grid and above the Load More button
  - Shows: "Showing {photos.length} of {totalCount} photos"
  - Styled with `text-muted text-sm text-center`

**3. Rewrite `app/(gallery)/gallery/GalleryContent.tsx`:**

- Change from a placeholder to a real gallery layout
- Still "use client" (needed for useSearchParams removal -- actually, searchParams are now handled by the Server Component, so this component just receives props)
- Wait -- since the Server Component page.tsx now handles searchParams and passes data as props, GalleryContent may no longer need to be a client component itself. But MasonryGrid is a client component. GalleryContent can become a thin layout wrapper that renders:
  - A header section with event title, date, and photo count
  - `<MasonryGrid>` component with the photo data
- Props: `event: GalleryEvent`, `initialPhotos: GalleryPhoto[]`, `totalCount: number`, `hasMore: boolean`
- The header: event title in `text-3xl font-bold`, event date formatted nicely, "X photos" count. Centered, with padding `px-4 py-8`.
- Make this a client component ("use client") because it renders MasonryGrid which is a client component. (Server Components can render client components as children, but the props passing is cleaner as a single client boundary here.)

**4. Update `app/(gallery)/gallery.css`:**
- Add the `react-photo-album/masonry.css` import (or import it in the component file directly -- component file is better to keep CSS co-located with usage)
- Add any custom overrides for the masonry grid within the warm theme (e.g., `.react-photo-album` background transparent, any rounding on photos)
- Add styles for the Load More button hover/active states if Tailwind utility classes are insufficient
- Add a simple CSS spinner animation for the loading state:
```css
@keyframes gallery-spin {
  to { transform: rotate(360deg); }
}
.gallery-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--color-border);
  border-top-color: var(--color-accent);
  border-radius: 50%;
  animation: gallery-spin 0.6s linear infinite;
}
```
  </action>
  <verify>
- `npm run build` passes with no errors
- Start dev server (`npm run dev`) and navigate to `/gallery?event={slug}` -- verify masonry grid renders if test data exists in Supabase, or verify the "event not found" / "no photos" states render correctly
- Verify `BlurhashPlaceholder` component decodes and renders a colored canvas
- Verify the Load More button appears when there are more than 50 photos
- Verify the progress indicator shows correct count
- Verify responsive columns: resize browser window to confirm 2/3/4/5 column breakpoints
  </verify>
  <done>
- MasonryPhotoAlbum renders photos in a Pinterest-style grid with correct aspect ratios
- Blurhash placeholders show instantly and fade out when images load
- Load More button fetches next 50 photos and appends them to the grid
- Progress indicator shows "Showing X of Y photos"
- Responsive column counts: 2 on phone, 3 on tablet, 4-5 on desktop
- All images use lazy loading and async decoding
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes with zero errors
2. Navigate to `/gallery?event={valid-slug}` -- photos render in masonry grid
3. Navigate to `/gallery` (no event param) -- shows "No event specified" message
4. Navigate to `/gallery?event=nonexistent` -- shows "Event not found" message
5. If event has >50 photos: Load More button visible, progress indicator shows "Showing 50 of N photos"
6. Click Load More -- next batch loads, count updates, grid grows
7. Resize browser: column count changes (2/3/4/5) at breakpoints
8. Photos show colored blurhash placeholder before image loads (throttle network in DevTools to verify)
9. Main site routes (`/`, `/services`, `/work`) are completely unaffected
</verification>

<success_criteria>
- Gallery renders real photos from Supabase in a masonry layout with preserved aspect ratios
- Server Component fetches initial batch (no client-side waterfall for first paint)
- Load More pagination works with progress feedback
- Blurhash placeholders provide instant visual feedback
- Build passes, no TypeScript errors, no console errors
</success_criteria>

<output>
After completion, create `.planning/phases/v1.1-02-gallery-display-design/02-01-SUMMARY.md`
</output>
