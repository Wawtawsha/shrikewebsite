---
phase: v1.1-03-social-features-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/useDeviceId.ts
  - lib/gallery.ts
  - types/gallery.ts
  - components/gallery/LikeButton.tsx
  - components/gallery/MasonryGrid.tsx
  - components/gallery/CommentSection.tsx
  - app/(gallery)/gallery/GalleryContent.tsx
  - app/(gallery)/gallery.css
autonomous: true

must_haves:
  truths:
    - "User can tap a heart icon on a photo in the grid and see it animate + count increment instantly"
    - "Tapping heart again un-likes the photo and decrements count instantly"
    - "Like state persists across page refreshes for the same device"
    - "User can type a comment with optional display name and submit it"
    - "Submitted comment appears immediately in the comment list below the grid"
    - "Comments are capped at 500 characters with visible counter"
  artifacts:
    - path: "hooks/useDeviceId.ts"
      provides: "localStorage device ID generation and retrieval"
      contains: "crypto.randomUUID"
    - path: "components/gallery/LikeButton.tsx"
      provides: "Heart toggle with optimistic count"
      min_lines: 40
    - path: "components/gallery/CommentSection.tsx"
      provides: "Comment form + comment list display"
      min_lines: 60
  key_links:
    - from: "components/gallery/LikeButton.tsx"
      to: "supabase.from('photo_likes')"
      via: "insert/delete on click"
      pattern: "supabase.*photo_likes"
    - from: "components/gallery/CommentSection.tsx"
      to: "supabase.from('photo_comments')"
      via: "insert on submit, select on mount"
      pattern: "supabase.*photo_comments"
    - from: "components/gallery/MasonryGrid.tsx"
      to: "components/gallery/LikeButton.tsx"
      via: "rendered per photo in grid"
---

<objective>
Build anonymous like/comment interactions for the gallery.

Purpose: This delivers the core social features (GALL-09, GALL-10) that transform the gallery from a passive photo viewer into an interactive experience. Likes and comments are what make event guests feel connected to the photos and each other.

Output: Working like button on every photo (optimistic toggle with count), comment section below the grid (form + list), and a shared device ID hook used by both features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SPAM_PROTECTION.md

@types/gallery.ts
@lib/gallery.ts
@lib/supabase.ts
@components/gallery/MasonryGrid.tsx
@components/gallery/GalleryLightbox.tsx
@app/(gallery)/gallery/GalleryContent.tsx
@app/(gallery)/gallery.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Device ID hook + Like button with optimistic UI</name>
  <files>
    hooks/useDeviceId.ts
    types/gallery.ts
    lib/gallery.ts
    components/gallery/LikeButton.tsx
    components/gallery/MasonryGrid.tsx
    app/(gallery)/gallery.css
  </files>
  <action>
    **1. Create `hooks/useDeviceId.ts`:**
    - Export a `useDeviceId()` hook that returns `string | null`
    - On mount (useEffect), read `localStorage.getItem('shrike_gallery_device')`
    - If not found, generate via `crypto.randomUUID()`, store it, then set state
    - Return `null` on server (SSR-safe) and the UUID string on client
    - Storage key: `'shrike_gallery_device'`

    **2. Update `types/gallery.ts`:**
    - Add `GalleryComment` interface: `{ id: string, photo_id: string, device_id: string, display_name: string, body: string, is_visible: boolean, created_at: string }`
    - Keep all existing types unchanged

    **3. Add like-fetching helper to `lib/gallery.ts`:**
    - Add `fetchUserLikes(eventId: string, deviceId: string): Promise<Set<string>>` — queries `photo_likes` table filtered by device_id, joins on photos.event_id to scope to this event, returns a Set of photo_id strings the device has liked
    - This runs client-side so use the existing `supabase` client

    **4. Create `components/gallery/LikeButton.tsx`:**
    - Props: `{ photoId: string, initialCount: number, isLiked: boolean, deviceId: string | null }`
    - Local state: `liked` (boolean), `count` (number)
    - On click:
      - If no deviceId, silently return (SSR guard)
      - **Optimistic update:** immediately toggle `liked` and increment/decrement `count`
      - If liking: `supabase.from('photo_likes').insert({ photo_id: photoId, device_id: deviceId })`
      - If un-liking: `supabase.from('photo_likes').delete().eq('photo_id', photoId).eq('device_id', deviceId)`
      - On error: revert the optimistic state (toggle back)
    - Render: a button with a heart SVG icon and the count number
      - Heart SVG: simple path, 20x20 viewBox
      - When liked: fill with `var(--color-heart)`, slight scale pulse animation (CSS `@keyframes heart-pop` — scale 1 -> 1.3 -> 1 over 300ms)
      - When not liked: stroke only, `var(--color-muted)` color
      - Count displayed next to heart, `var(--color-muted)` text, text-sm
      - Button has `gallery-tap-target` class for 48px min touch area
      - The button should have `aria-label` like "Like photo" / "Unlike photo"
    - Wrap in `React.memo` to avoid re-renders from parent photo list

    **5. Update `components/gallery/MasonryGrid.tsx`:**
    - Import `useDeviceId` and `LikeButton`
    - Import `fetchUserLikes` from `lib/gallery`
    - Add state: `userLikes: Set<string>` (initially empty)
    - Add useEffect: when deviceId becomes available, call `fetchUserLikes(eventId, deviceId)` and set the result
    - In the `ImageWithPlaceholder` component (or next to it), add the LikeButton overlay:
      - Position it at bottom-right of each photo div (absolute positioned)
      - Pass `photoId={photo.galleryPhoto.id}`, `initialCount={photo.galleryPhoto.like_count}`, `isLiked={userLikes.has(photo.galleryPhoto.id)}`, `deviceId={deviceId}`
    - The like button must NOT trigger the lightbox onClick. Use `e.stopPropagation()` inside LikeButton's click handler.
    - Keep all existing masonry/lightbox/load-more functionality unchanged

    **6. Add CSS to `app/(gallery)/gallery.css`:**
    - Add `@keyframes heart-pop` animation (scale 1 -> 1.3 -> 1, 300ms ease)
    - Add `.heart-pop` class that applies the animation
    - Add reduced-motion override: `@media (prefers-reduced-motion: reduce) { .heart-pop { animation: none; } }`
    - Add `.like-button-overlay` class for absolute positioning (bottom: 8px, right: 8px, with a subtle dark-to-transparent gradient backdrop for readability on light photos)
  </action>
  <verify>
    - `npm run build` passes with no errors
    - Visit `http://localhost:3000/gallery?event=vineyard-women-2026`
    - Heart icons visible on each photo in the grid
    - Click a heart: count increments, heart fills with coral/red color, animation plays
    - Click again: count decrements, heart returns to outline
    - Refresh page: previously liked photos still show as liked (heart filled)
    - Check Supabase dashboard: `photo_likes` table has rows with correct device_id
    - Try liking the same photo in an incognito window: works independently (different device)
    - Like button click does NOT open lightbox
  </verify>
  <done>
    - Heart toggle works with optimistic UI (instant visual feedback before server confirms)
    - Un-liking works (DELETE from photo_likes)
    - Like state persists across page refresh via device_id lookup
    - Heart animation plays on like (respects reduced-motion)
    - Like button does not interfere with photo click -> lightbox behavior
  </done>
</task>

<task type="auto">
  <name>Task 2: Comment section with form and display list</name>
  <files>
    components/gallery/CommentSection.tsx
    app/(gallery)/gallery/GalleryContent.tsx
    app/(gallery)/gallery.css
  </files>
  <action>
    **1. Create `components/gallery/CommentSection.tsx`:**

    This is a client component with two parts: a comment form and a comment list.

    **Props:** `{ eventId: string }`

    **State:**
    - `comments: GalleryComment[]` (loaded from DB)
    - `loading: boolean` (initial load)
    - `body: string` (textarea value)
    - `displayName: string` (optional input value)
    - `submitting: boolean`
    - `charCount: number` (derived from body.length)
    - `error: string | null` (for displaying submission errors)

    **On mount (useEffect):**
    - Fetch all visible comments for this event: query `photo_comments` joined through `photos.event_id` — actually simpler: just fetch `photo_comments` where `photo_id IN (select id from photos where event_id = eventId)`. But Supabase client doesn't support subqueries easily, so:
      - First fetch photo IDs: `supabase.from('photos').select('id').eq('event_id', eventId)`
      - Then fetch comments: `supabase.from('photo_comments').select('*').in('photo_id', photoIds).eq('is_visible', true).order('created_at', { ascending: false })`
    - Actually, reconsider: comments are about the EVENT, not individual photos. But the schema has `photo_id` on comments...

    **WAIT — re-read the schema:** `photo_comments` has `photo_id`. This means comments are per-photo, not per-event. But the task description says "comments section below the MasonryGrid." This is an event-level comment section (like a guestbook), not per-photo comments.

    **Resolution:** Use `photo_id` as NULL or use the event approach. Actually, looking at the DB schema from Phase 1: `photo_comments` has `photo_id UUID REFERENCES photos(id)`. This is designed for per-photo comments. But the UX requirement (GALL-10) says "anonymous comments" generally — it's a guestbook-style section below the gallery grid.

    **Practical approach:** Make comments event-level. Add a `fetchComments` function that queries comments for all photos in this event. Display them as a flat list below the grid. When submitting a comment, attach it to the FIRST photo of the event (or any photo — it doesn't matter since we display all event comments together). Actually, this is a hack.

    **Better approach:** The comment form lets users comment on the EVENT (guestbook style). Since the table requires `photo_id`, use a convention: comments with `photo_id` set to any photo in the event are event-level comments. When fetching, get all comments for all photos in the event. When inserting, use the first photo's ID as the anchor. This is pragmatic — the UI shows all comments together regardless of which photo_id they're attached to.

    **Implementation:**

    **Comment List:**
    - Fetch comments for all photos in this event (via photo_ids), ordered by created_at descending
    - Each comment renders: display_name (bold, default "Guest"), body text, relative time ("2 minutes ago" / "1 hour ago")
    - Use a simple `getRelativeTime(dateString)` helper inline (no library needed — just calculate diff in seconds and return appropriate string)
    - Style: each comment in a card (surface background, rounded, padding), stacked vertically with gap-3
    - Show "No comments yet — be the first!" when empty
    - Limit initial display to 20 comments, with "Show more" if there are more

    **Comment Form:**
    - Display name input: `<input type="text" placeholder="Your name (optional)" maxLength={50} />` — styled with warm theme, rounded, border
    - Comment body textarea: `<textarea placeholder="Leave a comment..." maxLength={500} />` — styled, auto-grows (min 3 rows, max 6 rows)
    - Character counter below textarea: `{charCount}/500` — turns `--color-heart` when > 450
    - Submit button: "Post Comment" — coral accent, full-width on mobile, disabled when body is empty or submitting
    - Error display: if `error` state is set, show it above the submit button in a subtle red/warm-error style

    **On submit:**
    - Get deviceId from `useDeviceId()` hook
    - Validate: body.trim().length > 0, body.length <= 500
    - If deviceId is null, show error "Unable to post — please try refreshing"
    - Get first photo ID from the event's photos (pass `firstPhotoId` as prop)
    - Insert: `supabase.from('photo_comments').insert({ photo_id: firstPhotoId, device_id: deviceId, display_name: displayName.trim() || 'Guest', body: body.trim() })`
    - On success: prepend the new comment to the local `comments` array (optimistic — the insert returns the row), clear form fields, reset charCount
    - On error: if error message contains "Too many comments", show "You're posting too fast — please wait a few minutes." Otherwise show "Something went wrong — please try again."
    - Set submitting=false

    **2. Update `app/(gallery)/gallery/GalleryContent.tsx`:**
    - Import `CommentSection`
    - Add the CommentSection below the MasonryGrid (or below the "0 photos" empty state)
    - Pass `eventId={event.id}` and `firstPhotoId={initialPhotos[0]?.id}` (only render CommentSection if there are photos)
    - Add a visual divider between grid and comments (horizontal rule or spacing)
    - Section heading: "Guest Book" with display font, centered

    **3. Add comment styles to `app/(gallery)/gallery.css`:**
    - `.comment-card` — background: var(--color-surface), border-radius: 12px, padding: 16px, border: 1px solid var(--color-border-subtle)
    - `.comment-form textarea` — resize: none, width: 100%, font-family: inherit, background: var(--color-surface-elevated), border: 1px solid var(--color-border), border-radius: 8px, padding: 12px, transition: border-color 0.2s
    - `.comment-form textarea:focus` — outline: none, border-color: var(--color-accent)
    - `.comment-form input` — same styling as textarea but single-line height
    - `.char-counter-warning` — color: var(--color-heart)
  </action>
  <verify>
    - `npm run build` passes with no errors
    - Visit `http://localhost:3000/gallery?event=vineyard-women-2026`
    - Scroll below the photo grid to see "Guest Book" section
    - Comment form visible with name input, textarea, character counter, and submit button
    - Type a comment: character counter updates in real-time
    - Submit with empty body: button is disabled
    - Submit with text: comment appears immediately at top of list with "Guest" as name
    - Submit with a display name: comment shows that name
    - Check Supabase dashboard: `photo_comments` table has the new row
    - Submit 4 comments quickly: 4th should show rate limit error message
    - Counter turns warning color near 500 chars
  </verify>
  <done>
    - Comment form renders below the photo grid with optional display name and body textarea
    - Character counter shows remaining (turns warning at 450+)
    - Submitted comments appear immediately in the list (optimistic prepend)
    - 500 char limit enforced both client-side (maxLength) and server-side (DB constraint)
    - Rate limit errors from DB trigger display as friendly user message
    - Empty state shows "No comments yet" prompt
    - Comments styled with warm theme (surface cards, rounded corners)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Like button works on every photo: tap to like (heart fills, count up), tap again to unlike (heart outline, count down)
3. Like state persists: refresh page, previously liked photos stay liked
4. Comment form functional: type comment, submit, see it appear
5. Rate limit works: 4th comment within 5 minutes triggers friendly error
6. All interactive elements have 48px+ tap targets
7. Reduced motion: heart animation disabled when `prefers-reduced-motion: reduce` is set
</verification>

<success_criteria>
- GALL-09 satisfied: Anonymous likes with device ID, UNIQUE constraint (DB-level), denormalized like_count (trigger), optimistic UI toggle
- GALL-10 satisfied: Anonymous comments with optional display name (default "Guest"), 500 char limit, DB constraints enforced
- Both features use shared `useDeviceId()` hook for localStorage-based anonymous identity
- Zero friction: no sign-up, no captcha, no visible security measures
- Mobile-friendly: 48px tap targets, full-width form on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/v1.1-03-social-features-polish/03-01-SUMMARY.md`
</output>
