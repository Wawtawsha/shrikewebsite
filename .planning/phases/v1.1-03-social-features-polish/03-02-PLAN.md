---
phase: v1.1-03-social-features-polish
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/gallery/CommentSection.tsx
  - components/gallery/GalleryLightbox.tsx
  - app/api/gallery/moderate/route.ts
  - lib/profanity.ts
  - app/(gallery)/gallery.css
autonomous: false

must_haves:
  truths:
    - "Bot-filled honeypot field causes silent rejection of comment"
    - "Comment submitted in under 2 seconds is silently rejected"
    - "Comment containing obvious profanity is blocked with user-friendly message before hitting the server"
    - "Gallery owner can delete inappropriate comments via admin endpoint"
    - "Deleted comments disappear from the visible comment list"
    - "User can download the full-size photo from the lightbox with one tap"
  artifacts:
    - path: "lib/profanity.ts"
      provides: "obscenity-based word filter"
      contains: "RegExpMatcher"
    - path: "app/api/gallery/moderate/route.ts"
      provides: "POST endpoint for comment soft-delete via service role"
      exports: ["POST"]
    - path: "components/gallery/GalleryLightbox.tsx"
      provides: "Lightbox with download button"
      contains: "Download"
  key_links:
    - from: "components/gallery/CommentSection.tsx"
      to: "lib/profanity.ts"
      via: "import and call before submit"
      pattern: "checkProfanity|isClean"
    - from: "app/api/gallery/moderate/route.ts"
      to: "SUPABASE_SERVICE_ROLE_KEY"
      via: "createClient with service role"
      pattern: "SUPABASE_SERVICE_ROLE_KEY"
    - from: "components/gallery/GalleryLightbox.tsx"
      to: "yet-another-react-lightbox/plugins/download"
      via: "plugin import"
      pattern: "Download"
---

<objective>
Add spam protection layers to the comment form, build a moderation endpoint for the gallery owner, and add photo download to the lightbox.

Purpose: This delivers the protective layers (GALL-11), moderation capability (GALL-12), and download feature (GALL-15) that make the gallery production-ready. Spam protection ensures the guestbook stays clean without any friction for legitimate users. Moderation gives the gallery owner a safety net. Download lets guests save their favorite photos.

Output: Honeypot + time check on comment form, client-side profanity filter via `obscenity`, Next.js API route for comment moderation (service role), download button in lightbox.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SPAM_PROTECTION.md

@.planning/phases/v1.1-03-social-features-polish/03-01-SUMMARY.md

@components/gallery/CommentSection.tsx
@components/gallery/GalleryLightbox.tsx
@components/gallery/MasonryGrid.tsx
@lib/supabase.ts
@app/(gallery)/gallery.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Spam protection layers + profanity filter + photo download</name>
  <files>
    lib/profanity.ts
    components/gallery/CommentSection.tsx
    components/gallery/GalleryLightbox.tsx
    app/(gallery)/gallery.css
  </files>
  <action>
    **1. Install `obscenity` package:**
    Run `npm install obscenity`

    **2. Create `lib/profanity.ts`:**
    ```typescript
    import { RegExpMatcher, englishDataset, englishRecommendedTransformers } from 'obscenity';

    const matcher = new RegExpMatcher({
      ...englishDataset.build(),
      ...englishRecommendedTransformers,
    });

    export function isClean(text: string): boolean {
      return !matcher.hasMatch(text);
    }
    ```
    - Export only the `isClean` function (single responsibility)
    - The matcher is module-level (created once, reused)

    **3. Update `components/gallery/CommentSection.tsx` — add 3 spam protection layers:**

    **Layer A — Honeypot field:**
    - Add a hidden input field named `website` inside the comment form
    - Add state: `honeypot: string` (initially empty)
    - Position it off-screen: `style={{ position: 'absolute', left: '-9999px' }}` with `aria-hidden="true"` and `tabIndex={-1}` and `autoComplete="off"`
    - Use a tempting label/name like "website" or "url" to attract bots
    - Do NOT use `display: none` or `visibility: hidden` (bots detect those)
    - On submit: if `honeypot.trim().length > 0`, silently return without error message (don't reveal the honeypot)

    **Layer B — Time-based check:**
    - Add a ref: `formRenderedAt = useRef(Date.now())`
    - On submit: calculate `elapsed = Date.now() - formRenderedAt.current`
    - If `elapsed < 2000` (under 2 seconds), silently return (no error message — don't reveal the check)
    - Reset `formRenderedAt.current = Date.now()` after each successful submission (so the timer restarts for the next comment)

    **Layer C — Client-side profanity filter:**
    - Import `isClean` from `lib/profanity`
    - On submit (after honeypot and time checks pass):
      - Check `isClean(body)` and `isClean(displayName)` (if displayName is provided)
      - If either fails: set error to "Please rephrase your message — some words aren't allowed."
      - Do NOT submit to the server if profanity detected

    **Order of checks on submit (short-circuit):**
    1. Honeypot check (silent reject)
    2. Time check (silent reject)
    3. Profanity filter (visible error message)
    4. Client-side validation (empty body, length)
    5. Server submission (with DB rate limit as final layer)

    **4. Update `components/gallery/GalleryLightbox.tsx` — add download button:**

    `yet-another-react-lightbox` has a built-in `Download` plugin. Use it.

    - Import: `import Download from "yet-another-react-lightbox/plugins/download";`
    - Add `Download` to the `plugins` array: `plugins={[Zoom, Download]}`
    - The plugin adds a download button to the toolbar automatically
    - The Download plugin uses the `slide.src` URL by default, which is already the full-size image URL (`getStorageUrl(photo.storage_path)`)
    - Add `download={{ download: async ({ slide }) => { ... } }}` prop ONLY if default behavior doesn't work with Supabase Storage URLs. The default behavior is to use an `<a download>` link which may not trigger download for cross-origin URLs.

    **Cross-origin download handling:**
    Supabase Storage URLs are on a different origin (`lualkffegfusyibldvqn.supabase.co`), so the `download` attribute on `<a>` tags won't work (browsers ignore `download` for cross-origin). Instead, provide a custom download handler:

    ```typescript
    download={{
      download: async ({ slide }) => {
        try {
          const response = await fetch(slide.src);
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = slide.src.split('/').pop() || 'photo.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch {
          // Fallback: open in new tab
          window.open(slide.src, '_blank');
        }
      }
    }}
    ```

    This fetches the image as a blob, creates a local object URL, and triggers a real download with the filename preserved.

    **5. Add download button styling to `app/(gallery)/gallery.css`:**
    - The lightbox Download plugin uses the yarl class namespace. Add:
    ```css
    .yarl__button--download {
      color: white;
    }
    ```
    - This ensures the download icon is visible against the dark lightbox backdrop
  </action>
  <verify>
    - `npm run build` passes with no errors
    - `npm ls obscenity` shows the package installed
    - Visit `http://localhost:3000/gallery?event=vineyard-women-2026`
    - **Spam protection tests:**
      - Submit a comment normally (>2 sec, no honeypot): works fine
      - Open DevTools, fill the hidden "website" field, submit: silently rejected (no comment appears)
      - Submit a comment containing a profanity word: error message "Please rephrase your message" appears, comment NOT submitted
      - Submit 4 comments in 5 minutes: 4th triggers "posting too fast" error from DB trigger
    - **Download test:**
      - Open lightbox by clicking a photo
      - Download button visible in lightbox toolbar
      - Click download: browser downloads the full-size image file
    - **Time check test (harder to test manually):**
      - The 2-second check prevents bot-speed submissions; manual testing won't trigger it since humans are slower
  </verify>
  <done>
    - Honeypot field invisibly rejects bot-filled submissions
    - Time check silently rejects sub-2-second submissions
    - Profanity filter gives clear user feedback before server roundtrip
    - Download button in lightbox fetches and saves full-size photo
    - All spam layers are zero-friction for legitimate users (invisible)
  </done>
</task>

<task type="auto">
  <name>Task 2: Moderation endpoint for gallery owner</name>
  <files>
    app/api/gallery/moderate/route.ts
  </files>
  <action>
    **Create `app/api/gallery/moderate/route.ts`:**

    This is a Next.js App Router API route that lets the gallery owner soft-delete comments by setting `is_visible = false`. It uses the Supabase service role key to bypass RLS.

    **Authentication:** Use a simple admin secret passed as a query parameter or Authorization header. The secret is the `SUPABASE_SERVICE_ROLE_KEY` itself — if someone has the service role key, they already have full DB access. So we check for a simpler admin token.

    **Actually, simplest approach:** Use an `ADMIN_SECRET` environment variable. The gallery owner hits the endpoint with `?secret=xxx`. This is sufficient for a private gallery with one owner.

    **BUT** — we don't want to add another env var for this. Instead: use the service role key as the admin secret. The owner already has it (they set up the Supabase project). The endpoint checks `Authorization: Bearer {SUPABASE_SERVICE_ROLE_KEY}` header.

    **Implementation:**

    ```typescript
    import { NextRequest, NextResponse } from 'next/server';
    import { createClient } from '@supabase/supabase-js';

    export async function POST(request: NextRequest) {
      // Verify admin authorization
      const authHeader = request.headers.get('Authorization');
      const token = authHeader?.replace('Bearer ', '');

      if (!token || token !== process.env.SUPABASE_SERVICE_ROLE_KEY) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
      }

      const { commentId } = await request.json();

      if (!commentId || typeof commentId !== 'string') {
        return NextResponse.json({ error: 'commentId required' }, { status: 400 });
      }

      // Use service role to bypass RLS
      const supabaseAdmin = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
      );

      const { error } = await supabaseAdmin
        .from('photo_comments')
        .update({ is_visible: false })
        .eq('id', commentId);

      if (error) {
        return NextResponse.json({ error: 'Failed to moderate comment' }, { status: 500 });
      }

      return NextResponse.json({ success: true });
    }
    ```

    **Key points:**
    - POST method only (modifying data)
    - Validates `Authorization: Bearer {service_role_key}` header
    - Validates `commentId` is a non-empty string
    - Soft-deletes (sets `is_visible = false`) rather than hard-deletes — preserves audit trail
    - Uses `createClient` with service role key (NOT the anon key) to bypass RLS
    - The service role Supabase client is created per-request (not module-level) to avoid cold-start key loading issues
    - Returns 401 for unauthorized, 400 for bad input, 500 for DB errors, 200 for success

    **Usage for gallery owner:**
    ```bash
    curl -X POST https://shrikemedia.com/api/gallery/moderate \
      -H "Authorization: Bearer {service_role_key}" \
      -H "Content-Type: application/json" \
      -d '{"commentId": "uuid-here"}'
    ```

    The owner can also use the Supabase dashboard directly to toggle `is_visible`. This endpoint is a convenience for programmatic access or a future admin UI.
  </action>
  <verify>
    - `npm run build` passes with no errors
    - **Test the endpoint locally:**
      - First, post a test comment via the gallery UI
      - Note the comment ID from Supabase dashboard
      - Run: `curl -X POST http://localhost:3000/api/gallery/moderate -H "Authorization: Bearer {your_service_role_key}" -H "Content-Type: application/json" -d "{\"commentId\": \"{comment_id}\"}"` — should return `{"success": true}`
      - Check Supabase dashboard: comment's `is_visible` is now `false`
      - Refresh gallery page: moderated comment no longer appears in the list
    - **Auth tests:**
      - Same curl without Authorization header: returns 401
      - Same curl with wrong token: returns 401
      - Same curl without commentId in body: returns 400
  </verify>
  <done>
    - POST /api/gallery/moderate endpoint exists and works
    - Authorization via service role key in Bearer header
    - Soft-deletes comments (is_visible = false), preserving data
    - Moderated comments no longer appear in gallery (RLS SELECT policy filters is_visible=true)
    - 401 for unauthorized, 400 for bad input, 200 for success
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete social features for the gallery: anonymous likes (heart toggle with optimistic UI), comment guestbook (form + display), spam protection (honeypot, time check, profanity filter, DB rate limit), moderation endpoint, and photo download in lightbox.
  </what-built>
  <how-to-verify>
    1. Visit http://localhost:3000/gallery?event=vineyard-women-2026 on your phone (or phone-sized browser)
    2. **Likes:** Tap a heart on a photo. Does it fill with color and increment? Tap again — does it un-like? Refresh — does the liked state persist?
    3. **Comments:** Scroll to Guest Book section. Type a comment with no name — does it post as "Guest"? Type with a name — does it show your name? Does the character counter work?
    4. **Download:** Tap a photo to open lightbox. See a download button in the toolbar? Tap it — does the photo download to your device?
    5. **Moderation (optional):** If you want to test, use the curl command from the plan to soft-delete a comment and confirm it disappears on refresh.
    6. **Overall feel:** Does it feel instant? No loading spinners for likes? Are tap targets large enough on mobile?
  </how-to-verify>
  <resume-signal>Type "approved" to mark Phase 3 complete, or describe any issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Honeypot field hidden but present in DOM (inspect element confirms `name="website"` input off-screen)
3. Profanity filter blocks obvious words with user-friendly message
4. Time check prevents sub-2-second submissions (testable by programmatically calling submit)
5. DB rate limit still works as final protection layer (4th comment in 5 min fails)
6. Moderation endpoint returns 401 without auth, 200 with correct auth
7. Moderated comments disappear from gallery display
8. Download button in lightbox downloads full-size image
9. All features work on mobile with proper tap targets
</verification>

<success_criteria>
- GALL-11 satisfied: Honeypot + time check + profanity filter (obscenity) + DB trigger rate limit — 4 layers of zero-friction spam protection
- GALL-12 satisfied: POST /api/gallery/moderate endpoint with service role key auth, soft-delete via is_visible flag
- GALL-15 satisfied: Download button in lightbox via yet-another-react-lightbox Download plugin with cross-origin blob fetch
- All protection layers are invisible to legitimate users
- Gallery owner can moderate via curl or Supabase dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/v1.1-03-social-features-polish/03-02-SUMMARY.md`
</output>
